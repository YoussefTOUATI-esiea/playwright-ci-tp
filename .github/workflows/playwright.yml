name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

# NOUVEAU : Configuration de la stratégie de matrice pour le sharding
    strategy:
      matrix:
        shard: [1, 2, 3]      # 3 shards = 3 machines en parallèle
        total-shards: [3]      # Total de 3 shards




    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-node@v5
      with:
        node-version: lts/*

        # NOUVEAU : Cache pour node_modules
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

    # NOUVEAU : Cache pour les navigateurs Playwright
    - name: Cache Playwright browsers
      uses: actions/cache@v3
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

   
    - name: Install dependencies
      run: npm ci

       # Installation de Playwright (seulement si cache manquant)
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps


      
      # NOUVEAU : Exécution des tests Playwright avec sharding
    - name: Run Playwright tests (Shard ${{ matrix.shard }}/${{ matrix.total-shards }})
      run: npx playwright test --shard=${{ matrix.shard }}/${{ matrix.total-shards }}

#Upload des rapports par shard
    merge-reports:
    runs-on: ubuntu-latest
    needs: test   # attend que tous les shards soient terminés

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '18'

    # Téléchargement des rapports de chaque shard
    - name: Download shard reports
      uses: actions/download-artifact@v4
      with:
        path: merged-reports

    # Fusion des rapports Playwright
    - name: Merge Playwright reports
      run: |
        npx playwright merge-reports --reporter html merged-reports/**/playwright-report

    # Upload du rapport final
    - uses: actions/upload-artifact@v4
      with:
        name: playwright-report-final
        path: playwright-report/
        retention-days: 30
